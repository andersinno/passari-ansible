---
- name: Create backup user
  user:
    name: "{{ passari_backup_user }}"
    home: "{{ passari_backup_home }}"
  tags: passari-backup

- name: Create backup PostgreSQL user
  postgresql_user:
    name: "{{ passari_backup_db_user }}"
    password: "{{ passari_backup_db_password }}"
    db: "{{ workflow_db_name }}"
    encrypted: true
    priv: CONNECT
  become_user: postgres
  tags: passari-backup

- name: Grant privileges to PostgreSQL backup user
  postgresql_privs:
    db: "{{ workflow_db_name }}"
    objs: ALL_IN_SCHEMA
    privs: SELECT
    type: "{{ item }}"
    role: "{{ passari_backup_db_user }}"
  loop:
    - "table"
    - "sequence"
  become_user: postgres
  tags: passari-backup

- name: Create pgpass file
  template:
    src: templates/pgpass.j2
    dest: "{{ passari_backup_home }}/.pgpass"
    owner: "{{ passari_backup_user }}"
    group: "{{ passari_backup_user }}"
    mode: u=rw,g=,o=
  tags: passari-backup

- name: Create backup directory
  file:
    path: "{{ passari_backup_dir }}"
    state: directory
  become_user: "{{ passari_backup_user }}"
  tags: passari-backup

- name: Create PostgreSQL backup script
  template:
    src: templates/backup-postgresql.sh.j2
    dest: "{{ passari_backup_dir }}/backup-postgresql.sh"
    mode: u=rwx,g=rx,o=rx
  become_user: "{{ passari_backup_user }}"
  tags: passari-backup

- name: Create backup service
  template:
    src: templates/backup-postgresql.service.j2
    dest: "/etc/systemd/system/backup-postgresql.service"
  tags: passari-backup

- name: Create backup timer
  template:
    src: templates/backup-postgresql.timer.j2
    dest: "/etc/systemd/system/backup-postgresql.timer"
  tags: passari-backup

- name: Reload systemd daemon
  systemd:
    daemon_reload: true
  tags: passari-backup

- name: Enable automatic PostgreSQL backups
  systemd:
    name: backup-postgresql.timer
    enabled: true
    state: started
  tags: passari-backup
